<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IFC Normalizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      background-color: #f5f5f5;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }
    button, .file-input {
      background-color: #0078d4;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    button:hover, .file-input:hover {
      background-color: #005a9e;
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      display: none;
    }
    .status.processing {
      background-color: #fff4cc;
      border: 1px solid #ffe066;
      display: block;
    }
    .status.completed {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      display: block;
    }
    .status.error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      display: block;
    }
    #dropZone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
    }
    #dropZone.active {
      border-color: #0078d4;
      background-color: #f0f7fd;
    }
    .process-diagram {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 12px;
      padding: 5px;
      margin: 10px 0;
      text-align: center;
      border: 1px solid #dee2e6;
    }
    .process-diagram h2 {
      margin-bottom: 0px;
      color: #343a40;
      font-size: 24px;
    }
    .api-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-top: 40px;
      position: relative;
      overflow: hidden;
    }
    .api-section::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
      pointer-events: none;
    }
    .api-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }
    .api-icon {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .api-title {
      flex: 1;
    }
    .api-title h2 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
    }
    .api-subtitle {
      margin: 5px 0 0 0;
      opacity: 0.9;
      font-size: 16px;
    }
    .api-content {
      position: relative;
      z-index: 1;
    }
    .api-benefits {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }
    .benefit-card {
      background: rgba(255, 255, 255, 0.15);
      padding: 20px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .benefit-card h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .benefit-card p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
      line-height: 1.4;
    }
    .toggle-details {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 20px;
      transition: all 0.3s ease;
    }
    .toggle-details:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }
    .api-details {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      display: none;
    }
    .api-details.show {
      display: block;
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .api-details pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .api-details code {
      background: transparent;
      color: #e2e8f0;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
    }
    .api-link {
      color: #a5f3fc;
      text-decoration: none;
      font-weight: 500;
    }
    .api-link:hover {
      color: #67e8f9;
      text-decoration: underline;
    }
  </style>
</head>
<body>
<h1>IFC Normalizer <img src="logo.png" alt="BIMpulse Logo" height="55" style="vertical-align: middle; float: right"></h1>

<div class="container">
  <!-- Prozessdiagramm hinzugefÃ¼gt -->
  <div class="process-diagram">
    <svg width="100%" height="150" viewBox="0 0 800 150" xmlns="http://www.w3.org/2000/svg">
      <!-- Schritt 1: Upload -->
      <g>
        <rect x="30" y="30" width="180" height="90" rx="10" fill="rgba(102, 126, 234, 0.1)" stroke="#667eea" stroke-width="2"/>
        <circle cx="120" cy="55" r="18" fill="#667eea"/>
        <text x="120" y="60" text-anchor="middle" fill="white" font-size="16" font-weight="bold">1</text>
        <text x="120" y="85" text-anchor="middle" fill="#667eea" font-size="12" font-weight="bold">IFC Datei hochladen</text>
        <text x="120" y="100" text-anchor="middle" fill="#666" font-size="10">Drag &amp; Drop oder</text>
        <text x="120" y="112" text-anchor="middle" fill="#666" font-size="10">Datei auswÃ¤hlen</text>
      </g>

      <!-- Pfeil 1 -->
      <g>
        <path d="M 220 75 L 270 75" stroke="#667eea" stroke-width="3" fill="none"/>
        <polygon points="265,70 275,75 265,80" fill="#667eea"/>
      </g>

      <!-- Schritt 2: Normalisierung -->
      <g>
        <rect x="290" y="30" width="220" height="90" rx="10" fill="rgba(118, 75, 162, 0.1)" stroke="#764ba2" stroke-width="2"/>
        <circle cx="400" cy="55" r="18" fill="#764ba2"/>
        <text x="400" y="60" text-anchor="middle" fill="white" font-size="16" font-weight="bold">2</text>
        <text x="400" y="85" text-anchor="middle" fill="#764ba2" font-size="12" font-weight="bold">Normalisierung gegen</text>
        <text x="400" y="97" text-anchor="middle" fill="#764ba2" font-size="12" font-weight="bold">BIM-Portal Properties</text>
        <text x="400" y="112" text-anchor="middle" fill="#666" font-size="10">Standardisierung</text>
      </g>

      <!-- Pfeil 2 -->
      <g>
        <path d="M 520 75 L 570 75" stroke="#667eea" stroke-width="3" fill="none"/>
        <polygon points="565,70 575,75 565,80" fill="#667eea"/>
      </g>

      <!-- Schritt 3: Bereitstellung -->
      <g>
        <rect x="590" y="30" width="180" height="90" rx="10" fill="rgba(118, 75, 162, 0.1)" stroke="#764ba2" stroke-width="2"/>
        <circle cx="680" cy="55" r="18" fill="#667eea"/>
        <text x="680" y="60" text-anchor="middle" fill="white" font-size="16" font-weight="bold">3</text>
        <text x="680" y="85" text-anchor="middle" fill="#667eea" font-size="12" font-weight="bold">Bereitstellung zur</text>
        <text x="680" y="97" text-anchor="middle" fill="#667eea" font-size="12" font-weight="bold">Weiterverarbeitung</text>
        <text x="680" y="112" text-anchor="middle" fill="#666" font-size="10">Download verfÃ¼gbar</text>
      </g>

    </svg>
  </div>
  <div id="dropZone">
    <h2>IFC-Datei hochladen</h2>
    <p>IFC-Datei hier hineinziehen oder</p>
    <input type="file" id="fileInput" accept=".ifc" />
  </div>
  <button id="uploadBtn" disabled>IFC-Datei Normalisieren</button>

  <div id="status" class="status">
    <h3 id="statusTitle">Status</h3>
    <p id="statusMessage"></p>
    <div id="downloadLinks" style="display: none;">
      <button id="downloadIfc">Normalisierte IFC herunterladen</button>
      <button id="downloadReport">Bericht herunterladen</button>
    </div>
  </div>
</div>

<div class="api-section">
  <div class="api-header">
    <div class="api-icon">ðŸš€</div>
    <div class="api-title">
      <h2>Enterprise API Integration</h2>
      <p class="api-subtitle">Integrieren Sie unseren IFC Normalizer nahtlos in Ihre bestehenden Workflows</p>
    </div>
  </div>

  <div class="api-content">
    <div class="api-benefits">
      <div class="benefit-card">
        <h3>âš¡ Automatisierung</h3>
        <p>Batch-Verarbeitung groÃŸer IFC-Dateien ohne manuelle Eingriffe</p>
      </div>
      <div class="benefit-card">
        <h3>ðŸ”— Nahtlose Integration</h3>
        <p>REST API fÃ¼r einfache Einbindung in bestehende CAD-Pipelines</p>
      </div>
      <div class="benefit-card">
        <h3>ðŸ“Š EchtzeitÃ¼berwachung</h3>
        <p>Live-Status-Updates und detaillierte Verarbeitungsberichte</p>
      </div>
    </div>

    <button class="toggle-details" onclick="toggleApiDetails()">
      <span id="toggleText">Technische Details anzeigen</span> â–¼
    </button>

    <div id="apiDetails" class="api-details">
      <p>Dieser Service bietet eine vollstÃ¤ndige REST API fÃ¼r die programmgesteuerte Nutzung:</p>
      <pre><code>POST /api/upload - IFC-Datei hochladen
GET /api/jobs/:jobId - Job-Status abrufen
GET /api/jobs/:jobId/ifc - Normalisierte IFC herunterladen
GET /api/jobs/:jobId/report - Bericht herunterladen</code></pre>
      <p>VollstÃ¤ndige Dokumentation unter <a href="/api" class="api-link">/api</a></p>
    </div>
  </div>
</div>

<script>
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const dropZone = document.getElementById('dropZone');
  const status = document.getElementById('status');
  const statusTitle = document.getElementById('statusTitle');
  const statusMessage = document.getElementById('statusMessage');
  const downloadLinks = document.getElementById('downloadLinks');
  const downloadIfc = document.getElementById('downloadIfc');
  const downloadReport = document.getElementById('downloadReport');

  let currentFile = null;
  let currentJobId = null;
  let pollInterval = null;

  // Toggle API Details
  function toggleApiDetails() {
    const details = document.getElementById('apiDetails');
    const toggleText = document.getElementById('toggleText');

    if (details.classList.contains('show')) {
      details.classList.remove('show');
      toggleText.textContent = 'Technische Details anzeigen';
    } else {
      details.classList.add('show');
      toggleText.textContent = 'Details ausblenden';
    }
  }

  // Dateiauswahl aktivieren
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      currentFile = e.target.files[0];
      uploadBtn.disabled = false;
      statusMessage.textContent = `Datei ausgewÃ¤hlt: ${currentFile.name} (${formatSize(currentFile.size)})`;
    } else {
      uploadBtn.disabled = true;
      currentFile = null;
    }
  });

  // Drag & Drop UnterstÃ¼tzung
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('active');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('active');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('active');

    if (e.dataTransfer.files.length > 0) {
      fileInput.files = e.dataTransfer.files;
      currentFile = e.dataTransfer.files[0];
      uploadBtn.disabled = false;
      statusMessage.textContent = `Datei ausgewÃ¤hlt: ${currentFile.name} (${formatSize(currentFile.size)})`;
    }
  });

  // Upload-Button
  uploadBtn.addEventListener('click', async () => {
    if (!currentFile) return;

    const formData = new FormData();
    formData.append('ifcFile', currentFile);

    try {
      uploadBtn.disabled = true;
      status.className = 'status processing';
      statusTitle.textContent = 'Verarbeitung lÃ¤uft...';
      statusMessage.textContent = 'Die IFC-Datei wird hochgeladen und verarbeitet...';

      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (response.ok) {
        currentJobId = data.jobId;
        statusMessage.textContent = `Verarbeitung gestartet. Job-ID: ${currentJobId}`;
        startPolling(currentJobId);
      } else {
        status.className = 'status error';
        statusTitle.textContent = 'Fehler';
        statusMessage.textContent = data.error || 'Beim Hochladen ist ein Fehler aufgetreten';
        uploadBtn.disabled = false;
      }
    } catch (err) {
      status.className = 'status error';
      statusTitle.textContent = 'Fehler';
      statusMessage.textContent = 'Verbindungsfehler: ' + err.message;
      uploadBtn.disabled = false;
    }
  });

  // Job-Status abrufen
  function startPolling(jobId) {
    if (pollInterval) clearInterval(pollInterval);

    pollInterval = setInterval(async () => {
      try {
        const response = await fetch(`/api/jobs/${jobId}`);
        const data = await response.json();

        if (response.ok) {
          if (data.status === 'completed') {
            clearInterval(pollInterval);
            status.className = 'status completed';
            statusTitle.textContent = 'Verarbeitung abgeschlossen';
            statusMessage.textContent = `Analysierte WÃ¤nde: ${data.numberOfWalls}`;
            downloadLinks.style.display = 'block';
            uploadBtn.disabled = false;
          } else if (data.status === 'error') {
            clearInterval(pollInterval);
            status.className = 'status error';
            statusTitle.textContent = 'Fehler bei der Verarbeitung';
            statusMessage.textContent = data.error || 'Ein unbekannter Fehler ist aufgetreten';
            uploadBtn.disabled = false;
          }
        } else {
          clearInterval(pollInterval);
          status.className = 'status error';
          statusTitle.textContent = 'Fehler';
          statusMessage.textContent = data.error || 'Fehler beim Abrufen des Job-Status';
          uploadBtn.disabled = false;
        }
      } catch (err) {
        // Bei temporÃ¤ren Netzwerkfehlern einfach weiter versuchen
        console.error('Polling-Fehler:', err);
      }
    }, 2000);
  }

  // Download-Buttons
  downloadIfc.addEventListener('click', () => {
    if (currentJobId) window.location.href = `/api/jobs/${currentJobId}/ifc`;
  });

  downloadReport.addEventListener('click', () => {
    if (currentJobId) window.location.href = `/api/jobs/${currentJobId}/report`;
  });

  // Hilfsfunktion fÃ¼r die Formatierung der DateigrÃ¶ÃŸe
  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' Bytes';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
  }
</script>
</body>
</html>
